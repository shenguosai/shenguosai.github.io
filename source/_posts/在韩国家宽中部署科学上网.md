---
title: 在韩国家宽中部署科学上网
date: 2025-07-22 09:37:23
tags: [科学上网,Nginx]
categories:
- [技术兴趣,网络服务]
password: 19820918
---
# 方式
VMESS+TLS+Websocket
# 环境
硬件: 中柏N305小主机，8核8线程，16G内存
虚拟机: Proxmox Virtual Environment 8.4.1
系统: Debian 12 (2核，4G内存)
# 1. VMESS(V2ray)
## 1.1 使用V2ray官方脚本安装
首先下载脚本：
```bash {.line-numbers}
curl -O https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh
```
然后执行脚本安装V2Ray
```bash {.line-numbers}
sudo bash ./install-release.sh
```

## 1.2 安装脚本介绍
此脚本会自动安装以下文件：
* ```/usr/local/bin/v2ray```: V2Ray程序；
* ```/usr/bin/v2ray/v2ctl```: V2Ray工具；
* ```/usr/local/etc/v2ray/config.json```: 配置文件
* ```/usr/local/share/v2ray/geoip.dat```: IP数据文件
* ```/usr/local/share/v2ray/geosite.dat```: 域名数据文件
* ```/var/log/v2ray/access.log```：警告日志
* ```/var/log/v2ray/error.log```:错误日志

此脚本会配置自动运行脚本。自动运行脚本会在系统重启之后，自动运行V2Ray。目前自动运行脚本只支持带有Systemd的系统，以及Debian/Ubuntu全系列。
运行脚本位于系统的以下位置：

* ```/etc/systemd/system/v2ray.service```: Systemd
* ```/etc/init.d/v2ray```: SysV

脚本运行完成后，你需要：
1.编辑 /etc/v2ray/config.json 文件来配置你需要的代理方式；
2.运行 service v2ray start 来启动V2Ray进程；
3.之后可以使用 service v2ray start|stop|status|reload|restart|force-reload 控制 V2Ray 的运行。

go.sh 支持如下参数，可在手动安装时根据实际情况调整：
* ```-p``` 或 ```--proxy```: 使用代理服务器来下载 V2Ray 的文件，格式与 curl 接收的参数一直，比如<br>```socks://127.0.0.1:1080"``` 或 ```"http://127.0.0.1:3128"```
* ```-f``` 或 ```--force```:强制安装。在默认情况下，如果当前系统中已有最新版本的 V2Ray，go.sh会在检测之后就退出。如果需要强制重装一遍，则需要指定该参数。
* ```--version```: 指定需要安装的版本，比如```v1.13```。默认值为最高版本。
* ```--local```: 使用一个本地文件进行安装。指定一个本地文件进行安装。如果你已经下载了某个版本的V2Ray，则可以通过这个参数指定一个文件路径来进行安装。
* 示例：<br>1.使用地址为 127.0.0.1:1080的SOCKS代理下载并安装最新版本：```./go.sh -p socks5://127.0.0.1:1080```<br>2.安装本地的 v1.13 版本：```./go.sh --version v1.13 --local /path/to/v2ray.zip

## 1.3 V2Ray的Windows客户端安装包介绍
下载链接：https://github.com/v2ray/v2ray-core/releases
如果是32位系统，下载v2ray-windows-32.zip；如果是64位版本，下载v2ray-windows-64.zip。下载解压后会有下面这些文件：

* ```v2ray.exe``` 运行V2Ray的程序文件
* ```wv2ray.exe``` 同v2ray.exe，区别在于wv2ray.exe是后台运行的，不想v2ray.exe会有类似于cmd控制台的窗口。运行V2Ray时从v2ray.exe和wv2ray.exe中任选一个即可
* ```config.json``` V2Ray的配置文件，后面我们对V2Ray进行配置其实就是修改这个文件
* ```v2ctl.exe``` V2Ray的工具，有多种功能，除特殊用途外，一般由v2ray.exe来调用，用户不用太关心
* ```geosite.dat``` 用于路由的域名文件
* ```geoip.dat``` 用于路由的IP文件
* ```其它``` 除上面的提到文件外，其他的不是运行V2Ray的必要文件。更详细的说明可以看doc文件夹下的readme.md文件。

## 1.4 原理介绍及配置
![节点](./inbound_outbound/inbound_outbound.png)

V2Ray本身提供配置检查功能(test选项)，还可以检查JSON语法错误外的问题。
```$ /usr/bin/v2ray/v2ray -test -config /etc/v2ray/config.json```

# 2. TLS
## 2.1 安装Nginx
```sudo apt install nginx```
安装后确认安装配置。
![Snipaste_2025-07-21_16-57-40](https://raw.githubusercontent.com/shenguosai/MyPic/img/img/Snipaste_2025-07-21_16-57-40.png)
默认没有安装 ssl 模块，需要加装。
### 2.1.1 下载同版本的安装包
[下载地址](https://nginx.org/en/download.html)
![20250722103003](https://raw.githubusercontent.com/shenguosai/MyPic/img/img/20250722103003.png)
找到对应版本的安装包下载至```/usr/local/src/```中，解压缩```tar -zvxf nginx-1.22.1.tar.gz```。
### 2.1.2 配置 SSL 模块
#### 2.1.2.1 在配置之前，需要先下载相应的依赖包。
```bash
sudo apt install gcc  #gcc
sudo apt install libpcre3 libpcre3-dev  #pcre
sudo apt isntall openssl libssl-dev #openssl
sudo apt install zlib1g-dev #zlib
```
#### 2.1.2.2 进入解压缩后的目录并执行配置 ssl 模块命令。
```bash
cd nginx-1.22.1
sudo ./configure \
--with-cc-opt='-g -O2 -ffile-prefix-map=/build/reproducible-path/nginx-1.22.1=. -fstack-protector-strong -Wformat -Werror=format-security -fPIC -Wdate-time -D_FORTIFY_SOURCE=2' \
--with-ld-opt='-Wl,-z,relro -Wl,-z,now -fPIC' \
--prefix=/usr/share/nginx \
--conf-path=/etc/nginx/nginx.conf \
--http-log-path=/var/log/nginx/access.log \
--error-log-path=stderr \
--lock-path=/var/lock/nginx.lock \
--pid-path=/run/nginx.pid \
--modules-path=/usr/lib/nginx/modules \
--http-client-body-temp-path=/var/lib/nginx/body \
--http-fastcgi-temp-path=/var/lib/nginx/fastcgi \
--http-proxy-temp-path=/var/lib/nginx/proxy \
--http-scgi-temp-path=/var/lib/nginx/scgi \
--http-uwsgi-temp-path=/var/lib/nginx/uwsgi \
--with-compat \
--with-debug \
--with-pcre-jit \
--with-http_ssl_module \
--with-http_stub_status_module \
--with-http_realip_module \
--with-http_auth_request_module \
--with-http_v2_module \
--with-http_dav_module \
--with-http_slice_module \
--with-threads \
--with-http_addition_module \
--with-http_flv_module \
--with-http_gunzip_module \
--with-http_gzip_static_module \
--with-http_mp4_module \
--with-http_random_index_module \
--with-http_secure_link_module \
--with-http_sub_module \
--with-mail_ssl_module \
--with-stream_ssl_module \
--with-stream_ssl_preread_module \
--with-stream_realip_module --with-http_ssl_module
```
**注意: 上述```./configure```指令中只有最后一行是加装 SSL 模块的 option，其它均为原自动安装时的 option，由于自动安装时的安装路径与软件发布者的默认路径不一致，所以一定要将安装路径等按原来相同进行配置，不然无法打开 nginx 服务。至于模块则按个人需求自行选择。由于原模块中有些 option 需要相关库才能进行编译，简便起见需要依赖库的 option 都删除未进行配置。**
出现下图画面，则说明配置成功。
![Snipaste_2025-07-21_17-06-22](https://raw.githubusercontent.com/shenguosai/MyPic/img/img/Snipaste_2025-07-21_17-06-22.png)
#### 2.1.2.3 编译
使用```make```命令进行编译。
```bash
sudo make
```
**注意不要使用```make install```命令，若使用则会重新安装，造成冲突。**
编译后会生成 objs 目录，进入 objs 目录复制 nginx 可执行文件覆盖掉原来的。
```bash
sudo cp ./objs/nginx /usr/sbin/nginx
```
#### 2.1.2.4 确认 SSL 加装成功
```bash
sudo /usr/sbin/nginx -V
```
如出现```configure arguments: –with-http_ssl_module```说明ssl模块已安装

## 2.2 安装证书
### 2.2.1 注册一个域名
TLS需要一个域名，关于如何获取取名，具体搜索相关文章教程。
注册好域名后务必记得添加一个A记录指向你的VPS。
### 2.2.2 证书生成
TLS是证书认证机制，所以使用TLS需要证书，证书也有免费的和付费的，同样的这里使用免费证书，证书认证机构为 [Let's Encrypt](https://letsencrypt.org/)。证书的生成有许多方法，这里使用的是比较简单的方法：使用 [acme.sh](https://github.com/Neilpang/acme.sh) 脚本生成，本部分说明部分内容参考于 [acme.sh README](https://github.com/Neilpang/acme.sh/blob/master/README.md)。
证书有两种，一种是ECC证书(内置公钥是ECDSA公钥)，一种是RSA证书(内置RSA公钥)。简单来说，同等长度ECC比RSA更安全，也就是说在具有同样安全性的情况下，ECC的密钥长度比RSA短的多(加解密会更快)。但问题是ECC的兼容性会差一些，Android 4.x以下和Windows XP不支持。只要设备不是非常老的古董，建议使用ECC证书。
以下给出两类证书的生成方法，请根据情况自行选择。
证书生成只需在服务器上操作。

#### 2.2.2.1 安装acme.sh
执行以下命令，acme.sh会安装到~/.acme.sh目录下。
```$ curl https://get.acme.sh | sh```
安装成功后执行 ```source ~/.bashrc``` 以确保脚本所设置的命令别名生效。

#### 2.2.2.2 使用 acme.sh 生成证书
在执行```acme.sh```脚本之前需要先安装```socat```依赖项: ```$ sudo apt-get install socat```。
从 2021 年 8 月 1 日起，默认 CA 将换成 [ZeroSSL](https://github.com/acmesh-official/acme.sh/wiki/ZeroSSL.com-CA)，同样支持免费签发 90 天期限的证书，包括通配符和 ECC 证书，甚至还支持 IP 证书，不过需要注册账号才行，所以要继续使用 Let's Encrypt 证书，有两种方案:
第一种是签发证书时制定 CA : ```acme.sh --issue --dns dns-cf -d domain.com --server letsencrypt```
另一种则是直接更改默认 CA : ```acme.sh --set-default-ca --server letsencrypt```
如果设置了默认的 CA ，以后就算版本升级也将一直默认使用指定的 CA。

#### <font color="pink">_证书生成_</font>
申请证书需要验证域名所有权，有两种域名所有权验证方式:
##### HTTP 验证 (Webroot)方式: 
此种方式```acme.sh```会在你的指定的网站根目录下自动生成一个文件，临时监听 80 端口，来验证域名所有权，然后自动完成验证并签发证书，完成后会自动删除验证文件，无需多余操作。但这种方式需要有服务器、公网 IP、开放 80 端口。
以下的命令会临时监听80端口，请确保执行该命令前80端口没有使用。
```$ sudo ~/.acme.sh/acme.sh --issue -d mydomain.me --standalone -k ec-256```
```-k``` 表示秘钥长度，后面的值可以使 ```ec-256```、```ec-384```、```2048```、```3072```、```4096```、```8192```，带有```ec```表示生成的是ECC证书，没有则是RSA证书。在安全性上256位的ECC证书等同于3072位的RSA证书。
##### DNS 认证方式(推荐)
这种方式只需要 DNS 的解析记录即可完成验证，一般主流域名服务商都提供 API 接口，目前```acme.sh```支持包括主流的 CloudFlare、DNSPod、Aliyun、Amazon Route53 在内的多达 131 个的域名 API，你可以在[这里](https://github.com/acmesh-official/acme.sh/wiki/dnsapi)查看详细的支持列表。这里以 CloudFlare 为例，获取 [CloudFlare API](https://dash.cloudflare.com/profile)，可以自己选择全局或是区域 API，然后导入:
```bash
export CF_Token="xxxxxxxxxxxxxxxxxxxxxxxx"
export CF_Account_ID="xxxxxxxxxxxxxxxxxxxxxxxx"
export CF_Zone_ID="xxxxxxxxxxxxxxxxxxxxxxxx"
```
其中 CF_Token 为你获取到的 API 秘钥，CF_Account_ID 和 CF_Zone_ID 可以在你的域名概述页面的 API 分栏看到。
签发证书:
```bash
acme.sh --issue --dns dns_cf -d domain1.com -d domain2.com
```
若要生成通配符证书，则:
```bash
acme.sh --issue --dns dns_cf -d domain1.com -d *.domain2.com
```
如果要签发 ECC 证书，需要在后面加上 --keylength 选项，下面的示例是签发一张 256 位长度的 EEC 通配符证书：
```bash
acme.sh --issue --dns dns_cf -d domain1.com -d *.domain2.com --keylength ec-256
```

#### <font color="pink">_证书更新_</font>
由于 [Let's Encrypt](https://letsencrypt.org/) 的证书有效期只有3个月，因此需要90天至少要更新一次证书，acme.sh脚本会每60天自动更新证书。也可以手动更新。
手动更新ECC证书，执行：```$ sudo ~/.acme.sh/acme.sh --renew -d mydomain.me --force --ecc```
如果是RSA证书，则执行：```$ sudo ~/.acme.sh/acme.sh --renew -d mydomain.me --force```

### 2.2.3 安装证书和秘钥
#### <font color="pink">_ECC证书_</font>
将证书和密钥安装到/etc/v2ray中：
```$ sudo ~/.acme.sh/acme.sh --installcert -d mydomain.me --fullchainpath usr/local/etc/v2ray/v2ray.crt --keypath /usr/local/etc/v2ray/v2ray.key --ecc```

#### <font color="pink">_RSA证书_</font>
```$ sudo ~/.acme.sh/acme.sh --installcert -d mydomain.me --fullchainpath /usr/local/etc/v2ray/v2ray.crt --keypath /usr/local/etc/v2ray/v2ray.key```
**注意：无论什么情况，密钥(即上面的v2ray.key)都不能泄露，如果你不幸泄露了密钥，可以使用 acme.sh 将原证书吊销，再生成新的证书，吊销方法请自行参考 acme.sh 的手册。**


### 2.2.4 验证
一般来说，按照以上步骤操作完成，V2Ray客户端能够正常联网说明TLS已经成功启用。但要是有个可靠的方法来验证是否正常开启TLs无疑更令人放心。验证的方法有很多，介绍一种小白化一点的，便是 [Qualys SSL Lab's SSL Server Test](https://www.ssllabs.com/ssltest/index.html)
**注意：使用[Qualys SSL Lab's SSL Server Test](https://www.ssllabs.com/ssltest/index.html)，在Hostname中输入你的域名，点提交，过一会结果就出来了。**

## 2.3 配置 nginx